---
title: "Projeto Final"
author: "Cristiana Aparecida Nogueira Couto"
date: "06/2020"
output: pdf_document
---

## Ref:

http://sape.inf.usi.ch/quick-reference/ggplot2/colour

http://users.dimi.uniud.it/~massimo.franceschet/ns/syllabus/make/ggraph/ggraph.html

https://www.sciencedirect.com/science/article/pii/S1201971211000245

```{r}
library(ggplot2)
library(outbreaks)
library(tidyverse)
library(ggraph)
library(tidygraph)

data("measles_hagelloch_1861")

head(measles_hagelloch_1861)

#Quantidade de pessoas com erupção cutânea reportadas por dia
dates_prodrome <- measles_hagelloch_1861 %>%
  select(case_ID, date_of_prodrome) %>%
  group_by(date_of_prodrome) %>%
  summarise(frequency = n())
  
dates_prodrome

#Plotar os casos acumulados
dates_rash <- measles_hagelloch_1861 %>%
  select(case_ID, date_of_rash) %>%
  group_by(date_of_rash) %>%
  summarise(frequency = n())

ggplot(dates_rash) +
  geom_area(aes(x = date_of_rash, y = frequency)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
  plot.title = element_text(hjust = 0.5)) +
  scale_x_date(date_labels = "%d/%m/%Y", date_breaks = "5 day") +
  labs(x = "Datas", y = "Frequência", 
  title = "Pessoas reportadas com erupção cutânea causada por sarampo")

ggplot(dates_prodrome) +
  geom_area(aes(x = date_of_prodrome, y = frequency)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
  plot.title = element_text(hjust = 0.5)) +
  scale_x_date(date_labels = "%d/%m/%Y", date_breaks = "5 day") +
  labs(x = "Datas", y = "Frequência", 
  title = "Pessoas reportadas com sinais de sarampo")

```

```{r fig.height = 10, fig.width = 5.5}
#Para quantas pessoas cada indivíduo infectado transmitiu a doença?
infector <- table(measles_hagelloch_1861$infector)
infector <- data.frame(Indivíduo = names(infector), 
                        Infectados_por_ele = as.vector(infector))
infector

#Melhorar labels
ggplot(infector) +
  geom_col(aes(x = reorder(Indivíduo, Infectados_por_ele),
               y = Infectados_por_ele), fill = "tomato1") +
  theme_bw() +
  coord_flip() +
  labs(y = "Quantidade de infectados pelo indíviduo", x = "Indíviduo", 
  title = "Número de pessoas que cada indivíduo transmitiu sarampo")

```

```{r}
#Quantas famílias foram afetadas?
ggplot(measles_hagelloch_1861) +
  geom_point(aes(x = case_ID, y = date_of_prodrome, color = factor(family_ID)))
```

```{r}
#Encontrando quem é a família do infector
infecções_fora_da_familia <- cbind(Family_infector= measles_hagelloch_1861$family_ID[measles_hagelloch_1861$infector], 
      Family_person = measles_hagelloch_1861$family_ID)

head(infecções_fora_da_familia)
```

```{r}
#Os indivíduos que estão na mesma familia tem a mesma localização
#Há algo que posso acrescentar na visualização das posições?
ggplot(measles_hagelloch_1861) +
  geom_point(aes(x = x_loc, y = y_loc)) +
  labs(name = "A localização espacial das casas dos indivíduos")
```

```{r fig.height = 8, fig.width = 12}
#ref:
#http://www.hellomister.com.au/data-blog/2019/7/30/creating-an-arc-plot-part-1

nodes <- measles_hagelloch_1861 %>%
  select(case_ID, class)

infector_edge <- measles_hagelloch_1861 %>%
  select(infector, case_ID, class, x_loc, y_loc) %>%
  rename(from = infector) %>%
  rename(to = case_ID) %>%
  na.omit()

head(infector_edge)

#Quem foi infectado por quem?
infector_tidy <- tbl_graph(edges = infector_edge, directed = TRUE, nodes = nodes)

infector1 <- ggraph(infector_tidy, layout = 'linear') +
  geom_edge_arc(aes(color = class)) +
  theme_bw() +
  theme(axis.title.y = element_blank(),
        axis.text.y = element_blank())

infector1

infector_edge45 <- measles_hagelloch_1861 %>%
  select(infector, case_ID, class, x_loc, y_loc) %>%
  rename(from = infector) %>%
  rename(to = case_ID) %>%
  filter(from == 45) %>%
  na.omit()

infector_tidy45 <- tbl_graph(edges = infector_edge45, directed = TRUE, nodes = nodes)

infector45 <- ggraph(infector_tidy45, layout = 'linear') +
  geom_edge_arc(aes(colour = class)) +
  theme_bw() +
  theme(axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        plot.title = element_text(hjust = 0.5, size = 20),
        legend.box.background = element_rect(colour = "black"),
        legend.position = c(0.9,0.75)) +
scale_x_continuous(breaks=seq(0, 200, 5)) +
labs(title = "Grafo dos casos infectados com sarampo pelo indivíduo 45", x = "Número de identificação dos casos.") +
  scale_edge_colour_discrete(name = "Classe")

infector45

```

```{r fig.height = 8.5, fig.width = 12}
infector2 <- ggraph(infector_tidy, layout = 'kk') +
  geom_edge_link(arrow = arrow(length = unit(1, 'mm')),
                 end_cap = circle(1.5, 'mm')) +
  geom_node_point(aes(colour = class), size = 3) +
  geom_node_text(aes(label = case_ID), repel = TRUE) + 
  theme_bw() +
  theme(axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        axis.text.x = element_blank(),
        axis.title.x = element_blank(),
        plot.title = element_text(hjust = 0.5, size = 20),
        legend.box.background = element_rect(colour = "black"),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        legend.position = c(0.95,0.8)) +
  scale_colour_manual("Classe", values = c('#46e566', '#4befef', '#ff8457')) +
  labs(title = "Grafo direcionado com os infectados por cada indivíduo diagnosticado com sarampo")

infector_tidy

infector2
```

## Perguntas
Quando foi o pico de casos? 

Para quantas pessoas cada indivíduo infectado transmitiu a doença?

Quem foi infectado por quem?

Existe alguma infecção fora da esfera familiar?

Qual a localização dos infectados?

Quantos dias em média levam da aparição do primeiro sinal até o início da erupção cutânea?

Quanto tempo durou o surto?

Quantas famílias foram afetadas?

```{r}
ggsave(
  filename = "graph.png",
  plot = last_plot(),
  device = NULL,
  path = NULL,
  scale = 1,
  width = 15,
  height = 10,
  units = c("in", "cm", "mm"),
  dpi = 300,
  limitsize = TRUE)
```

